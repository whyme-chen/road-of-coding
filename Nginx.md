# Nginx

官网：[nginx](https://nginx.org/)

学习参考：[黑马程序员Nginx教程](https://www.bilibili.com/video/BV1ov41187bq/?vd_source=fabefd3fabfadb9324761989b55c26ea)

## 概述

Nginx是一款高性能的http服务器/反向代理服务器及电子邮件( IMAP/POP3)代理服务器。由俄罗斯的程序设计师伊戈尔.西索夫(Igor Sysoev)所开发，官方测试nginx 能够支支撑5万并发链接，并且cpu、 内存等资源消耗却非常低，运行非常稳定。

### 主要功能

* HTTP 服务器功能
  - **处理静态资源**：Nginx 非常擅长高效地处理静态文件（如 HTML、CSS、JavaScript 文件、图片等）。当客户端请求一个静态文件时，Nginx 可以直接从磁盘读取文件并快速发送给客户端，而不需要经过复杂的脚本解释或应用程序处理。例如，对于一个简单的网站，其中包含大量的图片和样式表文件，Nginx 可以快速地将这些静态资源发送给访问网站的用户，大大提高了网站的访问速度。
  - **支持动态内容**：虽然 Nginx 本身主要是一个静态文件服务器，但它也可以通过与后端的应用服务器（如 PHP - FPM、uWSGI 等用于处理动态脚本的服务器）协同工作来处理动态内容。例如，当用户请求一个动态网页（如一个使用 PHP 编写的网页）时，Nginx 可以将请求转发给后端的 PHP - FPM 服务器进行处理，然后将处理后的结果返回给客户端。
* 反向代理功能
  - **隐藏后端服务器**：Nginx 作为反向代理服务器，可以将客户端的请求转发到后端的真实服务器，而客户端并不知道后端服务器的真实 IP 地址和内部架构。这增加了后端服务器的安全性，因为外部网络无法直接访问后端服务器。例如，对于一个大型的 Web 应用，其后端可能有多个应用服务器和数据库服务器，Nginx 作为反向代理可以将用户的请求均匀地分发到这些后端服务器上，同时对外隐藏这些服务器的具体信息。
  - **负载均衡**：Nginx 能够在多个后端服务器之间实现负载均衡。它可以根据不同的算法（如轮询、IP 哈希、最少连接数等）将客户端请求合理地分配到后端服务器上，从而提高整个系统的处理能力和可靠性。例如，一个电商网站在促销活动期间流量大增，通过 Nginx 的负载均衡功能，可以将大量的用户请求均匀地分配到多个 Web 服务器上，避免单个服务器过载，确保网站的稳定运行。
  - **缓存功能**：Nginx 可以缓存经常访问的内容，减少对后端服务器的请求次数。当客户端请求一个已经被 Nginx 缓存的内容时，Nginx 可以直接从缓存中提取数据并返回给客户端，而不需要再向后端服务器请求，这大大提高了响应速度。例如，对于一些很少更新的网页内容或者 API 接口数据，Nginx 可以设置缓存，从而加快用户的访问体验。
* 安全防护功能
  - **防止 DDoS 攻击**：Nginx 可以通过一些配置来帮助减轻分布式拒绝服务（DDoS）攻击的影响。例如，它可以限制单个 IP 地址的连接数或者请求频率，从而阻止恶意攻击者通过大量请求淹没服务器。同时，Nginx 的高性能也使得它在面对一定程度的 DDoS 攻击时，能够保持相对稳定的服务。
  - **SSL/TLS 加密**：Nginx 支持 SSL/TLS 协议，用于加密客户端和服务器之间的通信。这对于保护用户的敏感信息（如登录密码、信用卡信息等）非常重要。例如，在一个电商网站或者金融服务网站中，Nginx 可以配置 SSL 证书，确保用户和服务器之间的数据传输是安全加密的。

### 应用场景

* **网站服务**：无论是小型的个人网站还是大型的企业网站，Nginx 都可以作为 HTTP 服务器来提供快速高效的服务。对于高流量的网站，它的负载均衡和缓存功能可以显著提高网站的性能和稳定性。
* **API 网关**：在微服务架构中，Nginx 可以作为 API 网关，将外部客户端的 API 请求转发到内部的各个微服务上，同时进行身份验证、限流、缓存等操作，保护内部微服务的安全并提高系统的整体性能。
* **视频和音频流媒体服务**：Nginx 支持流媒体协议，可以用于构建视频和音频的流媒体服务器，提供流畅的流媒体播放体验。
* **反向代理、负载均衡**。当网站的访问量达到一定程度后，单台服务器不能满足用户的请求时，需要用多台服务器集群可以使用nginx 做反向代理。并且多台服务器可以平均分担负载，不会因为某台服务器负载高宕机而某台服务器闲置的情况。

### 基本概念

* 反向代理：**正向代理隐藏真实客户端，反向代理隐藏真实服务端。**

  * 正向代理是一个位于客户端和目标服务器之间的代理服务器。客户端通过配置使用正向代理服务器来访问目标服务器，对于目标服务器而言，它看到的请求来源是代理服务器，而不是真正的客户端。简单来说，正向代理是代表客户端去访问服务器。
  * 反向代理是位于目标服务器（如 Web 服务器）前面的服务器。对于客户端而言，它只知道反向代理服务器的存在，而不知道真正的后端服务器。反向代理服务器接收客户端的请求，然后将请求转发给后端的真实服务器，并将后端服务器的响应返回给客户端。简单来说，反向代理是代表服务器来接收客户端的请求。

* 负载均衡：一种将工作负载（如网络流量、计算任务等）均匀地分配到多个服务器、处理器或其他资源上的**技术和策略**。其目的是优化资源使用、提高系统的整体性能、可靠性和可扩展性，避免单点过载，确保系统能够高效、稳定地运行。

  * **负载均衡器的角色**：负载均衡器处于客户端和后端服务器集群之间，它就像是一个交通指挥中心，负责接收来自客户端的请求，并根据预先设定的算法将这些请求分配到后端的服务器上。例如，在一个 Web 应用的场景中，负载均衡器会接收用户对网站页面的访问请求，然后决定将这个请求发送到后端的哪一台 Web 服务器进行处理。

  - **健康检查机制**：负载均衡器会定期检查后端服务器的健康状况。它通过发送特定的探测请求（如 HTTP 请求来检查 Web 服务器是否正常响应）来确定服务器是否可用。如果某台服务器出现故障或者响应时间过长，负载均衡器会将其标记为不可用，并且不再将新的请求分配到这台服务器上，直到它恢复正常。例如，在一个数据中心里，负载均衡器会持续监测服务器的 CPU 使用率、内存占用、网络连接等指标，以确保只有健康的服务器参与请求处理。
  - 分配算法：
    - **轮询（Round - Robin）**：这是最简单的一种分配方式。按照顺序依次将请求分配给后端服务器。假设我们有三台服务器（服务器 A、服务器 B、服务器 C），第一个请求分配给服务器 A，第二个请求分配给服务器 B，第三个请求分配给服务器 C，第四个请求又回到服务器 A，如此循环。这种方式适用于服务器性能相近的情况，能够保证请求相对均匀地分配到各个服务器上。
    - **加权轮询（Weighted Round - Robin）**：考虑到后端服务器的性能可能不同，有些服务器的处理能力更强。在这种情况下，可以为服务器分配不同的权重。例如，服务器 A 的性能是服务器 B 的两倍，那么可以给服务器 A 分配的权重为 2，服务器 B 的权重为 1。在分配请求时，按照权重的比例进行分配，每收到 3 个请求，其中 2 个分配给服务器 A，1 个分配给服务器 B。这种方式能够更好地利用高性能服务器的处理能力。
    - **最少连接数（Least - Connections）**：负载均衡器会统计每个后端服务器当前正在处理的连接数，将新的请求分配给当前连接数最少的服务器。这种算法适用于服务器处理请求的时间差异较大的情况，能够确保每个服务器的负载相对均衡，避免某些服务器因为连接数过多而过载。
    - **IP 哈希（IP Hash）**：根据客户端的 IP 地址进行哈希计算，然后将请求固定分配到后端的某一台服务器上。例如，客户端 IP 地址经过哈希计算后得到一个数值，这个数值对应后端的某一台服务器。这样，同一个客户端的多次请求都会被分配到同一台服务器上，这对于需要保持会话状态（如用户登录后的操作）的应用场景非常有用。

* 动静分离：一种优化网站性能的**架构策略**。在 Web 应用中，“动” 指的是动态内容，这些内容通常是由服务器端脚本（如 PHP、Python、Java 等）动态生成的，例如根据用户的请求从数据库中获取数据并生成的网页内容；“静” 指的是静态内容，像 HTML、CSS、JavaScript 文件、图片、视频等可以直接提供给客户端，不需要服务器进行动态处理的资源。动静分离就是将这两种不同类型的内容分别处理，以提高网站的性能、可维护性和可扩展性。

### 下载与安装

下载地址：[nginx: download](https://nginx.org/en/download.html)

* 源码编译安装
* 包管理器安装
* 二进制程序安装

## 使用

### 常用命令

1. **启动 Nginx**
   - **命令格式**：`nginx`
   - 示例：在终端中直接输入`nginx`，系统会按照默认配置文件（通常是`/etc/nginx/nginx.conf`）来启动 Nginx 服务。这种方式适用于已经正确配置好 Nginx 并且希望快速启动服务的情况。启动后，Nginx 会开始监听指定的端口（默认为 80 端口用于 HTTP，443 端口用于 HTTPS），并准备处理客户端的请求。
2. **检查配置文件语法是否正确**
   - **命令格式**：`nginx -t`或`nginx -T`
   - 示例：
     - 使用`nginx -t`会检查主要配置文件（`nginx.conf`）的语法错误，并显示简单的结果。例如：`nginx -t`，如果配置文件语法正确，会显示`nginx: the configuration file /etc/nginx/nginx.conf syntax is correct`和`nginx: configuration file /etc/nginx/nginx.conf test is successful`；如果有语法错误，会指出错误的位置和大致原因。
     - `nginx -T`会打印出完整的配置信息，包括所有加载的配置文件内容（包括`http`、`server`、`location`等块的详细配置），并且也会检查语法错误。这在调试复杂配置时很有用，因为可以看到完整的配置上下文来查找可能导致问题的部分。
3. **重新加载配置文件**
   - **命令格式**：`nginx -s reload`
   - 示例：当你修改了 Nginx 的配置文件后，为了使新的配置生效，又不想中断正在进行的服务，可以使用`nginx -s reload`命令。例如，你添加了一个新的虚拟主机配置或者修改了服务器的反向代理规则后，执行`nginx -s reload`，Nginx 会重新加载配置文件，平滑地更新服务配置，已经建立的连接不会被中断，新的连接会按照新的配置进行处理。
4. **停止 Nginx 服务**
   - **命令格式**：`nginx -s stop`或`pkill -9 nginx`
   - 示例：
     - `nginx -s stop`是一种比较温和的停止方式，它会等待当前正在处理的请求结束后再停止服务。但如果 Nginx 服务出现异常情况，无法正常停止，可以使用`pkill -9 nginx`，这是一种强制停止的方式，它会立即终止 Nginx 进程。不过这种方式可能会导致一些正在处理的请求丢失，所以应该谨慎使用。
5. **查看 Nginx 进程**
   - **命令格式**：`ps -ef | grep nginx`或`pgrep nginx`
   - 示例：
     - 使用`ps -ef | grep nginx`可以查看所有与 Nginx 相关的进程信息，包括主进程和工作进程。例如，输出可能会显示主进程的 PID（进程标识符），以及各个工作进程的 PID、启动时间、占用的 CPU 和内存等信息，这有助于了解 Nginx 服务的运行状态和资源占用情况。
     - `pgrep nginx`则只返回 Nginx 进程的 PID，在编写脚本或者只需要快速获取进程 ID 时比较方便。
6. **查看 Nginx 版本信息**
   - **命令格式**：`nginx -v`（显示版本号）或`nginx -V`（显示版本号和编译参数）
   - 示例：
     - `nginx -v`会简单地输出 Nginx 的版本号，如`nginx version: 1.26.0`。这在快速确认 Nginx 版本时很有用，比如在排查版本相关的兼容性问题或者向他人报告系统环境时。
     - `nginx -V`会输出更详细的信息，包括版本号、编译时的配置参数（如使用了哪些模块、安装路径等）。例如，它可能会显示`nginx version: 1.26.0`，以及一系列`--with-xxx`或`--enable-xxx`的编译选项，这些信息对于深入了解 Nginx 的构建情况和功能支持很有帮助。

### 配置文件

* Nginx 的配置文件通常是一个文本文件，以块（block）的形式组织。主要的配置文件一般是`nginx.conf`，位于 Nginx 的安装目录下（二进制安装或源码安装方式）。
* 配置文件由**指令**（directives）和**指令块**（directive blocks）组成。指令是一个简单的名称 / 值对，指令块是一组用花括号`{}`包围的相关指令。

### 静态资源部署

### 
