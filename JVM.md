# JVM简介

Java虚拟机是一台执行Java字节码的虚拟计算机，它拥有独立的运行机制，其运行的Java字节码也未必由Java语言编译而成。

JVM平台的各种语言可以共享Java虛拟机带来的跨平台性、优秀的垃圾回收器，以及可靠的即时编译器。
Java技术的核心就是Java虚拟机(JVM，Java Virtual Machine)，因为所有的Java程序都运行在Java虚拟机内部。

1. jvm&jre&jdk

   ![image-20231219204824997](https://whymechen.oss-cn-chengdu.aliyuncs.com/image/202312192048550.png)

## JVM结构

JVM整体结构如下：

![image-20230903111409485](https://whymechen.oss-cn-chengdu.aliyuncs.com/image/202309031114189.png)

执行引擎有包含以下几部分：

* 解释器（Interpreter）
* 即时编译器（JIT Compiler）
* 垃圾回收（GC）

## JVM家族

1. Sun Classic/Exact VM

![image-20231219205628857](https://whymechen.oss-cn-chengdu.aliyuncs.com/image/202312192056537.png)

# 自动内存管理

## 分析诊断工具

常用的虚拟机内存分析诊断工具：

* `jstack`：它是JDK自带的一款命令行工具，用于生成当前Java进程的线程快照（Thread Dump），并且可以显示每个线程的堆栈信息。通过jstack可以查看线程是否处于死锁、哪些线程占用了过多的CPU资源等问题。
* `jps`：查看当前系统中的java进程
* `jmap`：查看堆内存占用情况
* `jvisualvm`：它是JDK自带的一款GUI工具，可以通过图形化界面实时监控Java应用程序的运行状态，支持线程、内存、CPU占用等方面的监控和分析。在jvisualvm中可以查看线程的状态、堆栈信息、内存使用情况等。
* `JConsole`：它也是JDK自带的一款GUI工具，类似于jvisualvm，可以通过图形化界面实时监控Java应用程序的运行状态，支持线程、内存、CPU占用等方面的监控和分析。在JConsole中可以查看线程数量、线程状态、内存使用情况等。
* `VisualVM`：它是JDK自带的一款扩展性较强的GUI工具，支持Java应用程序监控、性能分析、内存泄漏检测等功能。VisualVM整合了jvisualvm和JConsole的功能，并且支持插件式开发，可以通过安装插件实现更多的监控和分析功能。
* `Arthas`：它是阿里巴巴开源的一款Java诊断工具，支持实时查看Java应用程序的线程、堆栈、方法调用等信息，同时还提供了丰富的命令行工具，可以进行方法耗时统计、内存泄漏检测等操作。Arthas支持非侵入式诊断，无需修改代码或重启应用程序，方便快捷。
* `Jprofile`

## JVM内存结构

### 程序计数器

1. 程序计数器（Program  Counter Register）
2. 作用：记录程序执行过程中下一条jvm指令的地址
3. 特点
   * 线程私有的
   * 不会存在内存溢出

### 虚拟机栈

#### 原理

1. 栈：线程运行需要的内存空间

   > 可以通过vm参数：`-Xss`设置栈大小，比如：-Xss256k

2. 栈帧（Frame）：每个方法运行时需要的内存空间

   * 每个栈帧内部包含参数、局部变量、返回值地址。
   * 每一个线程只能有一个活动栈帧，对应着当前正在执行的那个方法。

3. 栈内存溢出

   * 栈帧过多（比如递归调用，没有出口）
   * 栈帧过大（比如创建一个非常大的数组）

#### 常见问题分析

1. 垃圾回收是否涉及栈内存？

   > 不涉及，栈内存随着方法运行的结束将自动回收

2. 占内存分配越大越好？

   > 否，因为物理内存是固定的，栈内存越大将会导致可用线程数越少

3. 方法内的局部变量是否线程安全？

   > 如果方法内局部变量没有逃离方法的作用范围，它是线程安全的，因为每个方法对应一个栈帧，不同的线程对应着不同的虚拟机栈，即对应不同虚拟机栈内各自的栈帧，线程间无法共享，所以是线程安全的。
   >
   > 如果是局部变量引用了对象，并逃离方法的作用范围，需要考虑线程安全。

4. cpu占用过高

   > Linux中线程运行诊断：
   >
   > 定位：
   >
   > * 使用top命令定位cpu占用过高的进程
   > * 使用ps命令定位cpu占用过高的线程
   > * 使用jstack 进程id，然后根据线程id进行一步分析并找到问题代码的源码位置

5. 程序运行很长时间没有结果

### 本地方法栈

1. 本地方法栈：用来支持Java程序调用本地方法（Native Method）的一部分内存区域。
   * 本地方法是指使用其他编程语言（如C、C++）编写的方法，而非纯Java代码。
   * 本地方法栈与Java虚拟机栈（Java Stack）类似，但在功能和作用上有所不同。Java虚拟机栈用于管理Java方法的调用和执行，而本地方法栈则用于管理本地方法的调用和执行。
   * 本地方法栈的结构与Java虚拟机栈类似，由栈帧（Stack Frame）组成。每个栈帧对应一个本地方法的执行，包含了本地方法的局部变量表和操作数栈。与Java虚拟机栈不同的是，本地方法栈中的栈帧不需要进行方法调用和返回的相关操作，因为本地方法的调用是由外部语言（如C、C++）完成的。
   * 本地方法栈的大小可以在Java虚拟机启动时通过参数进行设置，而且它的大小不会受到Java堆大小的限制。如果本地方法栈的空间不足，会抛出StackOverflowError异常。
   * 本地方法栈在Java虚拟机规范中并没有做强制要求，因此不同的JVM实现可能采用不同的策略来支持本地方法的调用和执行。
2. 作用
   * 行本地方法：当Java程序调用本地方法时，虚拟机会将当前线程切换到本地方法栈，并执行相应的本地方法代码。
   * 传递参数：本地方法栈用于传递参数给本地方法，并保存本地方法的局部变量。
   * 分配和释放本地资源：本地方法栈可以用于分配和释放本地资源，比如文件句柄、数据库连接等。

### 堆

1. 堆（Heap）
   * 通过`new`关键字创建对象都会使用堆内存。
   * 可以通过参数`-Xmx`修改堆内存大小
2. 特点
   * 不同于程序计数器、虚拟机栈、本地方法栈是线程私有的，堆是线程共享的，堆中对象都需要考虑线程安全问题。
   * 堆中的内存有垃圾回收机制。
3. 堆内存诊断

### 方法区

> 特别注意：**方法区是规范，永久代（jdk1.6，占用的是堆内存）和元空间（jdk1.8，占用的事系统内存）只是实现。**

1. 方法区：

2. 组成

   ![image-20231221213046044](https://whymechen.oss-cn-chengdu.aliyuncs.com/image/202312212130435.png)

3. 方法区内存溢出

   * 1.8以前会导致永久代内存溢出
   * 1.8以后会导致元空间内存溢出

#### 永久代

#### 元空间

#### 常量池

1. 常量池：常量池是编译阶段的一部分，是保存在.class文件中的。它包含了类、接口、方法中的常量、字段符号引用等信息。常量池中的数据可以被编译器直接使用，也可以在运行期间被加载到运行时常量池中。可以理解为一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等信息。
2. 运用时常量池：运行时常量池是在类加载过程中被创建的一块内存区域，它是方法区的一部分。运行时常量池是为了支持动态性而设计的，常量池在`*.class`文件中，当该类被加载，它的常量池信息就会放入运行时常量池，并把里面的符号地址变为真实地址。

##### StringTable

## 类加载机制

### 字节码文件（.class）

参考：https://pdai.tech/md/java/jvm/java-jvm-class.html

1. 字节码文件：class文件本质上是一个以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑的排列在class文件中。jvm根据其特定的规则解析该二进制数据，从而得到相关信息。

2. 文件结构属性

   ![img](https://whymechen.oss-cn-chengdu.aliyuncs.com/image/202212012327723.png)

3. 地方

### 加载流程

### 类加载器

# 参考资料

* 文档：
  * [Oracle官方](https://docs.oracle.com/javase/specs/index.html)
* 书籍：
  * 《深入理解Java虚拟机》
  * 《Java虚拟机规范》
  * 《自己动手写Java虚拟机》
* 视频：
  * [尚硅谷JVM](https://www.bilibili.com/video/BV1PJ411n7xZ/?p=1&vd_source=fabefd3fabfadb9324761989b55c26ea)
  * [黑马程序员JVM完整教程](https://www.bilibili.com/video/BV1yE411Z7AP/?vd_source=fabefd3fabfadb9324761989b55c26ea)
  * [实战java虚拟机](https://www.bilibili.com/video/BV1r94y1b7eS/?vd_source=fabefd3fabfadb9324761989b55c26ea)

* 文章：
  * [JVM（Java虚拟机）-史上最全、最详细JVM笔记](https://blog.csdn.net/weixin_56846554/article/details/129802936)